generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Hospital {
  id                String         @id @default(uuid())
  name              String
  type              HospitalType
  location          String
  status            HospitalStatus @default(PENDING)
  specialties       String[]
  contactEmail      String
  contactPhone      String
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  appointments      Appointment[]
  departments       Department[]
  patients          Patient[]
  sentReferrals     Referral[]     @relation("SentReferrals")
  receivedReferrals Referral[]     @relation("ReceivedReferrals")
  tasks             Task[]
  users             User[]
}

model User {
  id                  String               @id @default(uuid())
  email               String               @unique
  password            String
  name                String
  role                UserRole
  hospitalId          String?
  department          String?
  avatar              String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  userDepartmentId    String?
  appointments        Appointment[]        @relation("DoctorAppointments")
  auditLogs           AuditLog[]
  departmentHead      Department[]         @relation("DepartmentHead")
  emergencyAccessLogs EmergencyAccessLog[]
  messagesReceived    Message[]            @relation("Receiver")
  messagesSent        Message[]            @relation("Sender")
  receivedReferrals   Referral[]           @relation("ReceivingDoctor")
  sentReferrals       Referral[]           @relation("ReferringDoctor")
  sessions            Session[]
  assignedTasks       Task[]               @relation("AssignedTasks")
  createdTasks        Task[]               @relation("CreatedTasks")
  uploadedDocuments   MedicalDocument[]
  hospital            Hospital?            @relation(fields: [hospitalId], references: [id])
  userDepartment      Department?          @relation("UserDepartment", fields: [userDepartmentId], references: [id])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Patient {
  id                           String               @id @default(uuid())
  name                         String
  age                          Int
  gender                       Gender
  hospitalId                   String
  status                       PatientStatus        @default(ACTIVE)
  email                        String?
  phone                        String?
  bloodType                    String?
  allergies                    String[]             @default([])
  chronicConditions            String[]             @default([])
  lastVisit                    DateTime
  createdAt                    DateTime             @default(now())
  updatedAt                    DateTime             @updatedAt
  emergencyContactName         String?
  emergencyContactPhone        String?
  emergencyContactRelationship String?
  appointments                 Appointment[]
  emergencyAccessLogs          EmergencyAccessLog[]
  medicalRecords               MedicalRecord[]
  medicalDocuments             MedicalDocument[]
  hospital                     Hospital             @relation(fields: [hospitalId], references: [id])
  referrals                    Referral[]
  tasks                        Task[]
}

model Referral {
  id                 String          @id @default(uuid())
  patientId          String
  fromHospitalId     String
  toHospitalId       String
  referringDoctorId  String
  receivingDoctorId  String?
  department         String?
  status             ReferralStatus  @default(DRAFT)
  priority           Priority        @default(NORMAL)
  reason             String
  notes              String?
  emergencyConfirmed Boolean         @default(false)
  emergencyReason    String?
  immediateRisks     String?
  shareLabResults    Boolean         @default(true)
  shareImaging       Boolean         @default(false)
  shareNotes         Boolean         @default(true)
  emergencyAccess    Boolean         @default(false)
  rejectionReason    String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  fromHospital       Hospital        @relation("SentReferrals", fields: [fromHospitalId], references: [id])
  patient            Patient         @relation(fields: [patientId], references: [id])
  receivingDoctor    User?           @relation("ReceivingDoctor", fields: [receivingDoctorId], references: [id])
  referringDoctor    User            @relation("ReferringDoctor", fields: [referringDoctorId], references: [id])
  toHospital         Hospital        @relation("ReceivedReferrals", fields: [toHospitalId], references: [id])
  timeline           ReferralEvent[]
}

model ReferralEvent {
  id         String   @id @default(uuid())
  referralId String
  type       String
  actorId    String
  actorName  String
  details    String?
  timestamp  DateTime @default(now())
  referral   Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)
}

model MedicalRecord {
  id         String   @id @default(uuid())
  patientId  String
  type       String
  title      String
  details    String
  date       DateTime
  doctorId   String
  hospitalId String
  createdAt  DateTime @default(now())
  patient    Patient  @relation(fields: [patientId], references: [id])
}

model Message {
  id         String   @id @default(uuid())
  senderId   String
  receiverId String
  content    String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())
  receiver   User     @relation("Receiver", fields: [receiverId], references: [id])
  sender     User     @relation("Sender", fields: [senderId], references: [id])
}

model Task {
  id           String    @id @default(uuid())
  title        String
  description  String?
  priority     Priority  @default(NORMAL)
  status       String    @default("PENDING")
  patientId    String?
  hospitalId   String
  assignedToId String?
  assignedById String?
  dueDate      DateTime?
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  assignedTo   User?     @relation("AssignedTasks", fields: [assignedToId], references: [id])
  assignedBy   User?     @relation("CreatedTasks", fields: [assignedById], references: [id])
  hospital     Hospital  @relation(fields: [hospitalId], references: [id])
  patient      Patient?  @relation(fields: [patientId], references: [id])
}

model MedicalDocument {
  id                  String   @id @default(uuid())
  patientId           String
  title               String
  type                String
  cloudinaryUrl       String
  cloudinaryPublicId  String
  fileSize            Int?
  uploadedById        String
  createdAt           DateTime @default(now())
  patient             Patient  @relation(fields: [patientId], references: [id])
  uploadedBy          User     @relation(fields: [uploadedById], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  resource  String
  details   String?
  ipAddress String?
  timestamp DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Appointment {
  id         String   @id @default(uuid())
  patientId  String
  doctorId   String
  hospitalId String
  time       DateTime
  type       String
  status     String   @default("SCHEDULED")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  doctor     User     @relation("DoctorAppointments", fields: [doctorId], references: [id])
  hospital   Hospital @relation(fields: [hospitalId], references: [id])
  patient    Patient  @relation(fields: [patientId], references: [id])
}

model Department {
  id         String   @id @default(uuid())
  name       String
  hospitalId String
  headId     String?
  status     String   @default("ACTIVE")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  head       User?    @relation("DepartmentHead", fields: [headId], references: [id])
  hospital   Hospital @relation(fields: [hospitalId], references: [id])
  users      User[]   @relation("UserDepartment")
}

model EmergencyAccessLog {
  id        String    @id @default(uuid())
  userId    String
  patientId String
  reason    String
  startTime DateTime  @default(now())
  endTime   DateTime?
  status    String    @default("OPEN")
  createdAt DateTime  @default(now())
  patient   Patient   @relation(fields: [patientId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
}

enum UserRole {
  SYSTEM_ADMIN
  HOSPITAL_ADMIN
  DOCTOR
  NURSE
}

enum ReferralStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  COMPLETED
}

enum Priority {
  NORMAL
  URGENT
  EMERGENCY
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum PatientStatus {
  ACTIVE
  INACTIVE
  CRITICAL
  DISCHARGED
}

enum HospitalStatus {
  CONNECTED
  PENDING
  INACTIVE
}

enum HospitalType {
  GENERAL
  SPECIALTY
  CLINIC
  REHABILITATION
}
